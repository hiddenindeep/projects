# 商品检索与图文匹配

## 项目背景 

随着电子商务和内容平台的快速发展，用户对商品和信息的检索需求不再局限于简单的关键词匹配。传统的文本搜索（如基于商品标题或描述）面临“**语义鸿沟**”问题，即用户搜索的词语可能与商品描述的词语不完全一致，导致召回率低。

同时，用户越来越倾向于使用图片进行搜索（以图搜图），以及要求系统能理解图片内容，并推荐相关的文本描述（如标题）。这要求系统具备强大的**多模态理解能力**，能够将图片和文本映射到同一个语义空间，实现跨模态的检索与匹配。


## 项目目的

1.  **构建统一的语义空间：** 利用深度学习模型（如 CLIP、BERT 等）将商品图片和文本标题编码成统一的向量嵌入 (Embedding)，消除模态差异。
2.  **实现全方位的检索能力：** 在此语义空间的基础上，实现图-图、文-文、图-文、文-图 四种模式的**跨模态检索**。
3.  **提升召回与匹配精度：** 探索并应用高效的向量数据库技术（如 Milvus/Elasticsearch k-NN），确保在大规模商品数据集下，检索速度快、召回率高。
4.  **支撑应用层创新：** 为后续的智能推荐、内容生成（如基于图生成标题）、商品去重等高级应用提供坚实的技术基础。

## 项目要求

| 编号 | 功能模块 | 描述 | 关键产出 |
| :--- | :--- | :--- | :--- |
| **A1** | **图搜索图** | 输入一张商品图片，检索并返回库中 **最相似** 的 $N$ 张商品图片（应用于相似款查找、重复商品检测）。 | 相似图片列表 (Similarity Rank) |
| **A2** | **文本搜索文本** | 输入一段文本标题，检索并返回库中 **语义最相关** 的 $N$ 个商品标题（应用于语义搜索、近义标题匹配）。 | 语义相似标题列表 |
| **A3** | **图搜索文本** | 输入一张商品图片，检索并返回库中 **语义最匹配** 的 $N$ 个商品标题（应用于图片描述、商品自动打标题）。 | **基于图的合适标题** 列表 |
| **A4** | **文本搜索图** | 输入一段文本标题，检索并返回库中 **最符合描述** 的 $N$ 张商品图片（应用于关键词搜索，但基于语义理解）。 | **基于标题的合适图片** 列表 |
| **A5** | **文本生成图 (文生图)** | 输入一段商品标题或描述文本，生成一张与其语义内容相符的商品图片（应用于商品设计辅助、内容创意）。 | 基于标题生成的合适图片  |


## 技术栈

* **向量编码：** PyTorch, Hugging Face (CLIP Model)
* **向量数据库：** Milvus
* **服务框架：** Python (FastAPI/Flask)
* **数据集：** 实际电商商品图片和标题数据集（需进行脱敏和整理）。

## 开发过程

1. 信息存储（元信息、 向量的存储），mysql/sqlite + milvus
    向量数据库：存储和检索向量
    关系型数据库：存储元信息、更加稳定、更加容易扩容

关系型数据库（500qps，承受很高的并发度），很容易进行大批量的插入数据，更加稳定；
向量数据库（10 - 50 qps，需要进行向量相似度计算，不能承受很高的并发度， 打挂），功能型数据库，后台逐步处理数据，插入数据；
插入的数据 -》 kafka -〉 后台处理任务 -》 向量数据库中

> https://cloud.zilliz.com.cn/orgs

| 字段名称               | 字段类型           | 默认值 | 描述            | 操作 |
| :--------------------- | :----------------- | :----- | :-------------- | ---: |
| primary_keyPKAuto ID   | INT64              | --     | The Primary Key |      |
| image_clip_vectorIndex | FLOAT_VECTOR (512) | --     | --              |      |
| text_clip_vectorIndex  | FLOAT_VECTOR (512) | --     | --              |      |
| text_bge_vectorIndex   | FLOAT_VECTOR (512) | --     | --              |      |
| image_path             | VARCHAR (500)      | --     | --              |      |
| title                  | VARCHAR (500)      | --     | --              |      |
| 动态列                 |                    |        |                 |      |

mysql / milvus 表的设计？ -》 你去完成表设计 （架构师） -〉 确定之后就不会轻易改变
    拥有什么字段？
    字段的取值类型、是否为空、默认值、索引（常规的索引、向量ann近似检索索引）
    字段的相互关系

3. 模型（单模态的模型、 多模态的模型）
    图搜索图、 文本搜索文本： 单模态模型
    图搜索文本、文本搜索图：多模态模型

https://www.modelscope.cn/models/BAAI/bge-small-zh-v1.5
https://www.modelscope.cn/models/AI-ModelScope/chinese-clip-vit-base-patch16
   
3、 需要有信息管理的过程，需要开发两类接口：
    对信息管理的接口（偏向后端） -》 前端进行集成进行页面开发
    算法接口（偏向算法） -〉 算法实现

get /health 后端服务的状态检测
post /product 创建新的商品
get /prodcut/{product_id} 获取product_id的商品的信息
patch /prodcut/{product_id} 更新product_id的商品的信息
delete /prodcut/{product_id} 删除product_id的商品的信息
get /product/list 获取所有商品的列表

post /search 进行商品检索

设计的接口需要交付给前端，前端通过页面调用后端接口完成整个逻辑。

我们（算法+后端）最终交付：实现接口 + 调用文档；
前端：调用后端接口，搭建页面，完成整个页面逻辑流程；

product_id 是 关系型数据库中的id，不是在milvus的id；
    以 关系型数据库 为主；
    milvus id 不是从1开始的

4、建议写自己测试的例子

启动服务
fastapi run main.py

搭建出ui界面，模拟调用后端的过程
streamlit run web_demo.py --server.port=6006

## 文件结构

main.py 存储服务的核心逻辑，接受到请求之后的处理逻辑
data_models.py pydantic存储数据模型，传入/返回的结构，agent的一些结构
nlp_models.py nlp算法调用
orm_models.py 关系型数据库的定义
vector_db.py milvus的操作

web_demo.py streamlit带ui的调用
    pages/ 子页面的逻辑

tests 自己写的测试

## 项目

一条纪录：商品（商品标题、商品图片）
一条记录：变压器（设备标题、设备图片）

在XX时间，公司内部完成了一个复杂多模态商品检索和关系，具备了前后端分离的逻辑，可以进行海量的商品存储和管理 + 检索的过程，其中多模态部分使用clip实现，搭配miluvs和mysql进行数据管理，每天新增xx商品，平均检索耗时100ms，支持40并发。

    - 如何保证miluvs和mysql的数据同步的？ 关系型数据库中存储了milvus主键进行绑定。
    - 如何提高检索速度的？
    - 如何进行编码？
    - 如何提高clip精度？



